
%Exp dates: 20200317, 20200323, 20200408

% ===========================
% Load instants where insect are inside a cue volume and group them by time after the odor was released
%load the files list 
odorChecked='CO2';
if (exist('outputPath', 'var') &&  exist('outputFolder', 'var'))
    % Load files
    filesPath= strcat(outputPath, outputFolder, 'analysisData\');
    cd(filesPath);
    filesList=dir(strcat('*countsInsideCueVol_',odorChecked,'.xlsx'));
    cd(workspace);
    % Define number of groups to generate
    numGrps=120; %=120 =60 sec per group || =4 =1800 sec per grp
    %find the counts near visual cue over time and per experiment
    [filesNameList, p1, p2, p3, p4, t1, t2, IDsInP1, IDsInP2]= load_insect_data_per_time_groups(numGrps, filesPath, filesList);
    % save this information in a .CSV file in the project folder
    save_counts_over_time_in_file(p1, p2, p3, p4)
else
    disp('  * Warning: file path and/or folder not specified in the variabes workspace ');
end
%If loading AIR or postCO2 data, assign it to its correct variable
switch(odorChecked)
    case 'CO2'
        p1IDsCO2= IDsInP1;
        p2IDsCO2= IDsInP2;
        p1CO2= p1;
        p2CO2= p2;
        t1CO2= t1;
        t2CO2= t2;
        % For the 3hours exp, groups the subset of 30seconds in couples to make 1 minute each subset
        p1CO2(2:end,:)= horzcat(p1CO2(2:end,1:2:end)+p1CO2(2:end,2:2:end), zeros(length(p1CO2(2:end,1)),60));
        p2CO2(2:end,:)= horzcat(p2CO2(2:end,1:2:end)+p2CO2(2:end,2:2:end), zeros(length(p2CO2(2:end,1)),60));
        t1CO2(2:end,:)= horzcat(t1CO2(2:end,1:2:end)+t1CO2(2:end,2:2:end), zeros(length(t1CO2(2:end,1)),60));
        t2CO2(2:end,:)= horzcat(t2CO2(2:end,1:2:end)+t2CO2(2:end,2:2:end), zeros(length(t2CO2(2:end,1)),60));
    case'AIR'
        p1IDsAIR= IDsInP1;
        p2IDsAIR= IDsInP2;
        p1AIR= p1;
        p2AIR= p2;
        t1AIR= t1;
        t2AIR= t2;
        % The aclimatation part is ALWAYS 1 hour duration (for all exp
        % types), groups the subset of 30seconds in couples to make 1
        % minute each subset
        p1AIR= horzcat(p1AIR(:,1:2:end)+p1AIR(:,2:2:end));
        p2AIR= horzcat(p2AIR(:,1:2:end)+p2AIR(:,2:2:end));
        t1AIR= horzcat(t1AIR(:,1:2:end)+t1AIR(:,2:2:end));
        t2AIR= horzcat(t2AIR(:,1:2:end)+t2AIR(:,2:2:end));
    case'postCO2'
        p1IDsPostCO2= IDsInP1;
        p2IDsPostCO2= IDsInP2;
        p1PostCO2= p1;
        p2PostCO2= p2;
        t1PostCO2= t1;
        t2PostCO2= t2;
        % For the 3 hours exp, groups the subset of 30seconds in couples to make 1 minute each subset
        p1PostCO2(2:end,:)= horzcat(p1PostCO2(2:end,1:2:end)+p1PostCO2(2:end,2:2:end), zeros(length(p1PostCO2(2:end,1)),60));
        p2PostCO2(2:end,:)= horzcat(p2PostCO2(2:end,1:2:end)+p2PostCO2(2:end,2:2:end), zeros(length(p2PostCO2(2:end,1)),60));
        t1PostCO2(2:end,:)= horzcat(t1PostCO2(2:end,1:2:end)+t1PostCO2(2:end,2:2:end), zeros(length(t1PostCO2(2:end,1)),60));
        t2PostCO2(2:end,:)= horzcat(t2PostCO2(2:end,1:2:end)+t2PostCO2(2:end,2:2:end), zeros(length(t2PostCO2(2:end,1)),60));
end
%If you are only using 2 Visual Cues
clear p1 p2 p3 p4 t1 t2 numGrps odorChecked IDsInP1 IDsInP2
% ==================================================
% ==================================================    




% ====================== % of trajectories that went near cues
%TrajSummary contains information about the trajectories. Column values are: 
% [Number of Traj AIR, Avg duration traj AIR, Max. duration traj AIR, ...
%   Number of Traj CO2, Avg duration traj CO2, Max. duration traj CO2, ...   
%       Number of Traj PostCO2, Avg duration traj PostCO2, Max. duration traj PostCO2]
trajNearCues= zeros(length(filesList), 3);
temp= p1IDsAIR+p2IDsAIR;
tempNorm= bsxfun(@rdivide,(temp*100),trajSummary(:,1));
trajNearCues(:, 1)= tempNorm;
temp= p1IDsCO2+p2IDsCO2;
tempNorm= bsxfun(@rdivide,(temp*100),trajSummary(:,4));
trajNearCues(:, 2)= tempNorm;
temp= p1IDsPostCO2+p2IDsPostCO2;
tempNorm= bsxfun(@rdivide,(temp*100),trajSummary(:,7));
trajNearCues(:, 3)= tempNorm;

% ================ BOXPLOT FOR BLACK VS WHITE =================
% This boxPlot work with the Trajectories detected and  not the counts
% detected near a visual cue 
%boxplot([trajSummary(:,1), trajSummary(:,4),trajSummary(:,7)])
boxplot([trajNearCues(:,1), trajNearCues(:,2),trajNearCues(:,3)])
title('% of trajectories detected near cues')
xNames=[{'PriorCO2'}, {'WithCO2'},{'PostCO2'}];
set(gca,'XtickLabel', xNames);
ylabel('% of Trajectories')
% ==================================================
% ==================================================    


% ============= Gral. PI over counts near cues for timeGrps =================
% PI generated by ciomparing all the counts for all trajectories ID near
% each cue at a given time group.
% data can be generated with the last durAIR minutes of data to see how the
% PI changes in function of the CO2
duration=60; %(1 hour) 
p1BaseC= find(baseColorIndexList == 1);
p2BaseC= find(baseColorIndexList== 2);
if exist('p1AIR', 'var')
    %Add last data from the acclimatation hour
    durAIR= 10; 
    % Group the data per base and tested color 
    countsInBaseClr= [p1AIR(p1BaseC, (end-durAIR+1):end ), p1CO2(p1BaseC, 1:duration); ...
                      p2AIR(p2BaseC, (end-durAIR+1):end ), p2CO2(p2BaseC, 1:duration)];
    countsInTestClr= [p2AIR(p1BaseC, (end-durAIR+1):end ), p2CO2(p1BaseC, 1:duration); ...
                      p1AIR(p2BaseC, (end-durAIR+1):end ), p1CO2(p2BaseC, 1:duration)];
    % Increase the total duration of the dataset
    duration= durAIR+duration;
else
    % Group the data per base and tested color 
     countsInBaseClr= [p1CO2(p1BaseC, 1:duration); p2CO2(p2BaseC, 1:duration)];
     countsInTestClr= [p2CO2(p1BaseC, 1:duration); p1CO2(p2BaseC, 1:duration)];
end
totalCounts= countsInBaseClr + countsInTestClr;

% Estimate the PI towards the tested cue for all experiments in the workspace
%piPerTimeGrp_list=zeros(length(filesList), duration);
tempPI= zeros(1, duration);
piPerTimeGrpList= zeros(length(filesList), duration);
for i=1: length(filesList)
    for k=1:duration
        %Generate the PI for the given ID
        tempPI(k)= (countsInTestClr(i, k) - countsInBaseClr(i, k)) / (totalCounts(i, k));
    end
    tempPI(isnan(tempPI))=0;
    %countsInTimeGrp_list(i).piList= tempPI;
    %countsInTimeGrp_list(i).meanPI= mean(tempPI);
    piPerTimeGrpList(i,:)= tempPI;
end
% ==================================================
% ==================================================    



% ================ BOXPLOT FOR BLACK VS WHITE =================
%  calculate number of trajectories near the cues versus the number of
%  trajectories outside the cues for AIR/CO2/postCO2



% ==================================================
% ==================================================    



%Bar plot showing the preference index per time group of 60 sec and the
%mean value per time group of 60 sec
figure()
x=-9:1:60;
maxCts= max(max(totalCounts(:,:)));

for i=1:length(filesName)
    subplot(3,2,i)
    yyaxis left;
    %bar(countsInTimeGrp_list(i).piList)
    bar(x, piPerTimeGrpList(i,:), 'hist', 'FaceColor','flat');
    hold on
    plot(x, mean(piPerTimeGrpList), 'ro-', 'MarkerSize',4,'MarkerEdgeColor','r', 'MarkerFaceColor',[0.8,0.4,0.4])
    plot([0, 0], [-1, 1], ':', 'MarkerSize',5, 'MarkerEdgeColor',[0.5, 0.5, 0.5], 'MarkerFaceColor',[0.5,0.5,0.5])
    hold off
    ylabel('Preference Index');
        
    yyaxis right;
    plot(x, totalCounts(i,:), '-g', 'MarkerSize',15);
    ylim([-maxCts, maxCts]);
    xlim([-11,60]);
    ylabel('Total counts detected near the cues');
    
    xlabel('Minute #')
    lg= [{'PI in  given time grp'}, {strcat('mean PI per time grp (',num2str(length(filesName)),' exp)')}, {'Total counts in time grp'}];
    legend(lg  ,'location', 'eastoutside');
    title(filesName(i))
end


%Figure with the mean of all experiments values
x=-9:1:60;
maxCts= max(max(totalCounts(:,:)));
figure()
yyaxis left;
plot([0.5, 0.5], [-0.5, 1], ':', 'MarkerSize',8, 'color',[0.1, 0.1, 0.1])
hold on
bar(x, mean(piPerTimeGrpList), 'hist')
hold off
ylabel('Preference Index');
ylim([-0.5, 1]);
yyaxis right;
plot(x, totalCounts(i,:), 'ro-', 'MarkerSize',3,'MarkerEdgeColor','r', 'MarkerFaceColor',[0.9,0.5,0.5])
ylim([-maxCts, maxCts]);
ylabel('Counts near cues');
xlabel('Minute #')
xlim([-11,62]);
lg= [{'Separation between AIR & CO2'}, {strcat('mean PI per time grp (',num2str(length(filesName)),' exp)')},{'Total counts in time grp'}];
legend(lg  ,'location', 'southeast');
title(strcat('Mean Counts Per Time group (',num2str(length(filesList)),' exp)'))
   

% Bar plot to show the total counts used in each time group of 60 sec
% average counts per time group of 60 sec during the 5 experiment
figure()
maxCts= max(max(totalCounts(:,:)));
%lg= {'Total counts in time grp';
for i=1:length(filesName)
    subplot(3,2,i)
    %bar(countsInTimeGrp_list(i).piList)
    yaxis left; 
    bar(totalCounts(i,:))
    hold on
    plot(mean(totalCounts), 'ro-', 'MarkerSize',5,'MarkerEdgeColor','r', 'MarkerFaceColor',[0.9,0.5,0.5])
    ylabel('# of counts near any of the cues');
    ylim([0, maxCts]);
    yaxis right;
    
    hold off
    xlabel('Minute #')
    lg= [{'Total counts in time grp'}, {strcat('mean value per time grp (',num2str(length(filesName)),' exp)')}];
    legend(lg  ,'location', 'eastoutside');
    title(filesName(i))
end
clear maxCts




% 
% % =============
% % How is the PI values per group of time of 60 sec.
% duration= 120;   %Number of groups to work with (first 60 groups= 1st hour)
% for expIndex= 1: length(filesNameList)
%     for i= 1:duration
%         if baseColorIndexList(expIndex) == 1
%             tempPI(i)= (t2CO2(expIndex, i) - t1CO2(expIndex, i)) / (t1CO2(expIndex, i) + t2CO2(expIndex, i));
%         else
%             tempPI(i)= (t1CO2(expIndex, i) - t2CO2(expIndex, i)) / (t1CO2(expIndex, i) + t2CO2(expIndex,i));    
%         end
%     end
%     %Eliminate NaN values
%     tempPI(isnan(tempPI))=[];
%     % added to the data structure
%     dataFromTimeGrp(expIndex).piList= tempPI;
% end
% clear duration
% 
% % SCATTER FOR BLACK VS WHITE 
% % for Pref Index per time spent each ID near the cues
% figure()
% for k=1:length(dataFromTimeGrp)
%     subplot(2,length(dataFromTimeGrp),k)
%     scatter(ones(1, size(dataFromTimeGrp(k).piList,2)),dataFromTimeGrp(k).piList, 'jitter', 'on')
%     hold on
%     plot(median(dataFromTimeGrp(k).piList), 'ro', 'MarkerSize',10,'MarkerEdgeColor','r', 'MarkerFaceColor',[0.9,0.5,0.5]);
%     y= [mean(dataFromTimeGrp(k).piList), mean(dataFromTimeGrp(k).piList)];
%     plot([0.7, 1.3], y, '--k', 'MarkerSize',15,'MarkerEdgeColor','k');
%     hold off
%     title('PI time spent near cue per timeGrp (60s)');
%     ylabel('Preference Index'); 
%     xlim([0.5, 1.5]);
%     xlabel(strcat('# of time groups= ',num2str(length(dataFromTimeGrp(k).piList))));
%     
%     subplot(2,length(dataFromTimeGrp),(k+length(dataFromTimeGrp)))
%     histogram(dataFromTimeGrp(k).piList,[-1:0.1:1]);
%     ylabel(' Repeats for value');
%     xlabel('Preference Index')
%     title(filesNameList(k))
% end
% clear y
% ====================================================
% ====================================================







% ========   
% * What are the dynamics of the experiment
% Initialize variable to obtain the mean and std error per colorCue  
duration=60; %lets work with only the first hour (of each of the parts of the exp)
totalExp= length(filesNameList);

%Sum the counts per position for each of the time groups
sumPerColorAIR= cumsum(p1AIR(:,1:duration)+p2AIR(:,1:duration),2);
sumPerColorCO2=cumsum(p1CO2(:,1:duration)+p2CO2(:,1:duration), 2);
sumPerColorPostCO2=cumsum(p1PostCO2(:,1:duration)+p2PostCO2(:,1:duration),2);
% Sum the times spend by some insects in the volume, is there any difference with the counts plot?
sumTimeInPosCO2= cumsum(t1CO2(:,1:duration)+t2CO2(:,1:duration), 2);
sumTimeInPosAIR= cumsum(t1AIR(:,1:duration)+t2AIR(:,1:duration), 2);
sumTimeInPosPostCO2= cumsum(t1PostCO2(:,1:duration)+t2PostCO2(:,1:duration), 2);

% If several exp, generates the mean over their cummulative sum over time
% -> Working with the COUNT near visual cue matrices
tempNorm= bsxfun(@rdivide,(sumPerColorAIR*100),sumPerColorCO2(:,end));
tempNorm(isnan(tempNorm))=[];
meanPerColorAIR= mean(tempNorm);
errAIR= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumPerColorCO2*100),sumPerColorCO2(:,end));
tempNorm(isnan(tempNorm))=[];
meanPerColorCO2= mean(tempNorm);
errCO2= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumPerColorPostCO2*100),sumPerColorCO2(:,end));
tempNorm(isnan(tempNorm))=[]; 
meanPerColorPostCO2= mean(tempNorm);
errPostCO2= std(tempNorm)/sqrt(totalExp);    

% -> Working with the TIME near visual cue matrices
tempNorm= bsxfun(@rdivide,(sumTimeInPosAIR*100),sumTimeInPosCO2(:,end));
tempNorm(isnan(tempNorm))=[]; 
meanTimeAIR= mean(tempNorm);
errTimeAIR= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumTimeInPosCO2*100),sumTimeInPosCO2(:,end));
tempNorm(isnan(tempNorm))=[]; 
meanTimeCO2= mean(tempNorm);
errTimeCO2= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumTimeInPosPostCO2*100),sumTimeInPosCO2(:,end));
tempNorm(isnan(tempNorm))=[]; 
meanTimePostCO2= mean(tempNorm);
errTimePostCO2= std(tempNorm)/sqrt(totalExp);

clear sumPerColorAIR sumPerColorCO2 sumPerColorPostCO2 tempNorm
clear sumTimeInPosCO2 sumTimeInPosAIR sumTimeInPosPostCO2
%SHADED ERROR BAR
x= 1:duration; %[1:60; 1:60; 1:60; 1:60]
%Plot the counts withCO2 vs postCO2 each plot is for a value of gray
figure()
%set(gcf,'Title', title);
lg= [{'Pre CO2'}, {'With CO2'},{'Post CO2'}];
shadedErrorBar(x, meanPerColorAIR(1,:)', errAIR(1,:)','lineprops','-b')
%pp1.YLim= [0 max(max(meanList))+2000];
ylim([0 125]);
hold on;
shadedErrorBar(x, meanPerColorCO2(1,:)', errCO2(1,:)','lineprops','-r')
shadedErrorBar(x, meanPerColorPostCO2(1,:)', errPostCO2(1,:)','lineprops','-g')
hold off;
xlabel('Minute #');
%xlim([1, 120]);
ylabel(' % Counted ');
title(strcat('Counts around the visual cues (white vs black)x',num2str(totalExp)));
legend(lg, 'Location','eastoutside');

clear x duration lg totalExp

% ==================================================
% ==================================================    


 % =====  cumSum RAW DATA of the 3 parts of the experiment
sumPerColorAIR= cumsum(p1AIR(:,1:duration)+p2AIR(:,1:duration),2);
sumPerColorCO2=cumsum(p1CO2(:,1:duration)+p2CO2(:,1:duration), 2);
sumPerColorPostCO2=cumsum(p1PostCO2(:,1:duration)+p2PostCO2(:,1:duration),2);
maxCts= max(max(max(sumPerColorAIR(:,end)), max(sumPerColorCO2(:,end))), max(sumPerColorPostCO2(:,end)));
figure()
title('Counts near both cues for prevCO2 vs withCO2 vs postCO2');
%set(gcf,'Title', title);
lg= [{'Pre CO2'}, {'With CO2'},{'Post CO2'}];
totalExp= length(filesNameList);
for i= 1:totalExp
    subplot(2,3,i);
    plot(sumPerColorAIR(i, :)');
    hold on
    plot(sumPerColorCO2(i,:)');
    plot(sumPerColorPostCO2(i,:)');
    hold off
    xlabel('Minute #');
    ylim([1, maxCts]);
    ylabel(' Counts ');
    title(filesNameList(i));
    legend(lg, 'Location','northwest');
end
clear i sumPerColorAIR sumPerColorCO2 sumPerColorPostCO2 macCts lg totalExp

% ==================================================
% ==================================================


    
%============================================================
% Working with time durations near a visual cue. 
% --> The insect behavior itis very similar to their behavior when 
%       counting frames where the insect has been near the cue

% ========   
% * Do the dynamics change between experiments
duration= 16;
totalExp= length(filesNameList);
% Find in which position the base and test color wehre placed
p1BaseC= find(baseColorIndexList == 1);
p2BaseC= find(baseColorIndexList== 2);

%sum the times for each type ovf visual cue     
sumTimeInBaseClrAIR= cumsum([t1AIR(p1BaseC, 1:duration); t2AIR(p2BaseC, 1:duration)], 2);
sumTimeInTestClrAIR= cumsum([t2AIR(p1BaseC, 1:duration); t1AIR(p2BaseC, 1:duration)], 2);
sumTimeInBaseClrCO2= cumsum([t1CO2(p1BaseC, 1:duration); t2CO2(p2BaseC, 1:duration)], 2);
sumTimeInTestClrCO2= cumsum([t2CO2(p1BaseC, 1:duration); t1CO2(p2BaseC, 1:duration)], 2);
sumTimeInBaseClrPostCO2= cumsum([t1PostCO2(p1BaseC, 1:duration); t2PostCO2(p2BaseC, 1:duration)], 2);
sumTimeInTestClrPostCO2= cumsum([t2PostCO2(p1BaseC, 1:duration); t1PostCO2(p2BaseC, 1:duration)], 2);
% obtain the total of time spent in both cues
totalTimeCO2= sumTimeInBaseClrCO2(:,end) +sumTimeInTestClrCO2(:,end);


%Do the same for the counts when the CO2 is being released
sumCountsInBaseClrCO2= cumsum([p1CO2(p1BaseC, 1:duration); p2CO2(p2BaseC, 1:duration)], 2);
sumCountsInTestClrCO2= cumsum([p2CO2(p1BaseC, 1:duration); p1CO2(p2BaseC, 1:duration)], 2);
totalCountsCO2= sumCountsInBaseClrCO2(:,end) +sumCountsInTestClrCO2(:,end);
%Do the same for the counts for the PostCO2 part
sumCountsInBaseClrPostCO2= cumsum([p1PostCO2(p1BaseC, 1:duration); p2PostCO2(p2BaseC, 1:duration)], 2);
sumCountsInTestClrPostCO2= cumsum([p2PostCO2(p1BaseC, 1:duration); p1PostCO2(p2BaseC, 1:duration)], 2);

%Normalize the amount of time spend near each color cue
tempNorm= bsxfun(@rdivide,(sumTimeInBaseClrAIR*100),totalTimeCO2);
tempNorm(isnan(tempNorm))=[]; 
meanTimeAIRcB= mean(tempNorm);
errTimeAIRcB= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumTimeInTestClrAIR*100),totalTimeCO2);
tempNorm(isnan(tempNorm))=[]; 
meanTimeAIRcT= mean(tempNorm);
errTimeAIRcT= std(tempNorm)/sqrt(totalExp);     

tempNorm= bsxfun(@rdivide,(sumTimeInBaseClrCO2*100),totalTimeCO2);
tempNorm(isnan(tempNorm))=[]; 
meanTimeCO2cB= mean(tempNorm);
errTimeCO2cB= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumTimeInTestClrCO2*100),totalTimeCO2);
tempNorm(isnan(tempNorm))=[]; 
meanTimeCO2cT= mean(tempNorm);
errTimeCO2cT= std(tempNorm)/sqrt(totalExp);

tempNorm= bsxfun(@rdivide,(sumTimeInBaseClrPostCO2*100),totalTimeCO2);
tempNorm(isnan(tempNorm))=[]; 
meanTimePostCO2cB= mean(tempNorm);
errTimePostCO2cB= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumTimeInTestClrPostCO2*100),totalTimeCO2);
tempNorm(isnan(tempNorm))=[]; 
meanTimePostCO2cT= mean(tempNorm);
errTimePostCO2cT= std(tempNorm)/sqrt(totalExp);

%Do the same for the counts when the CO2 is being released
tempNorm= bsxfun(@rdivide,(sumCountsInBaseClrCO2*100),totalCountsCO2);
tempNorm(isnan(tempNorm))=[]; 
meanCtsCO2cB= mean(tempNorm);
errCtsCO2cB= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumCountsInTestClrCO2*100),totalCountsCO2);
tempNorm(isnan(tempNorm))=[]; 
meanCtsCO2cT= mean(tempNorm);
errCtsCO2cT= std(tempNorm)/sqrt(totalExp);

%Do the same for the counts and PostCO2
tempNorm= bsxfun(@rdivide,(sumCountsInBaseClrPostCO2*100),totalCountsCO2);
tempNorm(isnan(tempNorm))=[]; 
meanCtsPostCO2cB= mean(tempNorm);
errCtsPostCO2cB= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumCountsInTestClrPostCO2*100),totalCountsCO2);
tempNorm(isnan(tempNorm))=[]; 
meanCtsPostCO2cT= mean(tempNorm);
errCtsPostCO2cT= std(tempNorm)/sqrt(totalExp);

%USING SHADED ERROR BAR
x= 1:duration; %[1:60; 1:60; 1:60; 1:60]
%Plot the counts withCO2 vs postCO2 each plot is for a value of gray
figure(1);
%set(gcf,'Title', title);
lg= [{'Base color'}, {'Test color'}];
figure(1);
%Data from AIR
pp1=subplot(2,2,1);
% time near the cues with the Base color as cue
shadedErrorBar(x, meanTimeAIRcB', errTimeAIRcB','lineprops','-g')
pp1.YLim= [0 100];
hold on;
% time near the cues with the Test color as cue
shadedErrorBar(x, meanTimeAIRcT', errTimeAIRcT','lineprops','-b')
hold off;
xlabel('Minute #');
ylabel(' % time per position ');
title('Time spent in White cue vs Black cue (AIR - 1st hr.)');
legend(lg, 'Location','eastoutside');  
% Data from CO2
pp1=subplot(2,2,2);
% time near the cues with the Base color as cue
shadedErrorBar(x, meanTimeCO2cB', errTimeCO2cB','lineprops','-g')
pp1.YLim= [0 100];
hold on;
% time near the cues with the Test color as cue
shadedErrorBar(x, meanTimeCO2cT', errTimeCO2cT','lineprops','-b')
hold off;
xlabel('Minute #');
ylabel(' % time per position ');
title('Time spent in White cue vs Black cue (CO2 - 1st hr.)');
legend(lg, 'Location','eastoutside');  
%Data from POSTCO2
pp1=subplot(2,2,3);
% time near the cues with the Base color as cue
shadedErrorBar(x, meanTimePostCO2cB', errTimePostCO2cB','lineprops','-g')
pp1.YLim= [0 100];
hold on;
% time near the cues with the Test color as cue
shadedErrorBar(x, meanTimePostCO2cT', errTimePostCO2cT','lineprops','-b')
hold off;
xlabel('Minute #');
ylabel(' % time per position ');
title('Time spent in White cue vs Black cue (PostCO2 - 1st hr.)');
legend(lg, 'Location','eastoutside');  
%Data from COUNTS in CO2
pp1=subplot(2,2,4);
% time near the cues with the Base color as cue
shadedErrorBar(x, meanCtsCO2cB', errCtsCO2cB','lineprops','-g')
pp1.YLim= [0 100];
hold on;
% time near the cues with the Test color as cue
shadedErrorBar(x, meanCtsCO2cT', errCtsCO2cT','lineprops','-b')
hold off;
xlabel('Minute #');
ylabel(' % counts per position ');
title('Counts near White cue vs Black cue (PostCO2)');
legend(lg, 'Location','eastoutside');  


%Using Shaded error to plot the POSTCO2 behavior (counts and time spend
%around)
figure()
%PostCO2 counts
pp1=subplot(2,1,1);
% time near the cues with the Base color as cue
shadedErrorBar(x, meanCtsPostCO2cB', errCtsPostCO2cB','lineprops','-g')
pp1.YLim= [0 100];
hold on;
% time near the cues with the Test color as cue
shadedErrorBar(x, meanCtsPostCO2cT', errCtsPostCO2cT','lineprops','-b')
hold off;
xlabel('Minute #');
ylabel(' % time per position ');
title('Counts in White cue vs Black cue (PostCO2)');
lg= [{'Base color'}, {'Test color'}];
legend(lg, 'Location','eastoutside');  
%PostCO2 time between counts
pp1=subplot(2,1,2);
% time near the cues with the Base color as cue
shadedErrorBar(x, meanTimePostCO2cB', errTimePostCO2cB','lineprops','-g')
pp1.YLim= [0 100];
hold on;
% time near the cues with the Test color as cue
shadedErrorBar(x, meanTimePostCO2cT', errTimePostCO2cT','lineprops','-b')
hold off;
xlabel('Minute #');
ylabel(' % time per position ');
title('Time spent in White cue vs Black cue (PostCO2 - 1st hr.)');
lg= [{'Base color'}, {'Test color'}];
legend(lg, 'Location','eastoutside');  

% ==================================================
% ==================================================


%    =========================================
% === PrefIndex per 2x2 cm2 square in XZ plane ===
%    =========================================

% ========== Load data from the xls files per experiment ========
% From all the trajectories inside the cues, pick the ones we have X time before they entered the cue.
% Divide the XZ plane of the WT in 2x 2 cm2 squares (sub-square)
% “Generate the PI for each sub-squareas the amount of time spent on the side of the wind tunnel of the test object compared to the control object, divided by their sum.” (Each sub-square will have a list of PI values (one for each ID that pass around that cue)) and all the cubes crossed by a trajectory will have the same PI vale (for that trajectory ID)
% "Generate the mean PI value for each one of the sub-square accros all trajectories and its 95% confidence interval"

% Load for each trajectory ID its first time it enters the a volume
odorChecked='CO2';
if (exist('outputPath', 'var') &&  exist('outputFolder', 'var'))
    % Load files
    filesPath= strcat(outputPath, outputFolder, 'analysisData\');
    cd(filesPath);
    filesList=dir(strcat('*countsInsideCueVol_',odorChecked,'.xlsx'));
    cd(workspace);
    for fileIndex= 1:length(filesList)
        fileName= filesList(fileIndex).name;
        disp(strcat(' - Working with file: ', {' '}, fileName));
        filesName(fileIndex)= {fileName(1:15)};
        % data loaded structure: [vCuePosition	objID	timeStamp NaN initialTimeStamp finalTimeStamp]
        dataFromExcel = table2array(readtable(strcat(filesPath, fileName)));
        if isempty(dataFromExcel)
            disp(strcat('   -> No counts detected in file: ',{' '}, fileName));
            % The matrices p1..p4 and t1, t2 will keep its 0 values in row assigned to this empty file 
        else
            %Sort the data
            sortedData= sortrows(dataFromExcel(:,[1,2,3,6]));
            %find the first appearence of the position 2 
            split= find(sortedData(:,1) ==2,1);
            %Find the information related to the Pos1
            uniqueIDs= unique(sortedData(1:(split-1),2));
            %initialize the structure containing the data to use in this analysis
            expData(fileIndex).idListP1= uniqueIDs';
            expData(fileIndex).tsListP1= zeros(1,length(uniqueIDs));
            expData(fileIndex).firstIxP1= zeros(1,length(uniqueIDs));
            expData(fileIndex).lastIxP1= zeros(1,length(uniqueIDs));
            for i= 1:length(uniqueIDs)
                %Find the TimeStamp and Raw data index for the first time the ID enters the volume
                tempIndex= find(sortedData(1:(split-1),2)==uniqueIDs(i),1);
                expData(fileIndex).tsListP1(i)= sortedData(tempIndex, 3);
                expData(fileIndex).firstIxP1(i)= sortedData(tempIndex, 4);
                %Find the TimeStamp and Raw data index for the last time the ID is inside the volume
                tempIndex= find(sortedData(:,2)==uniqueIDs(i),1, 'last');
                expData(fileIndex).lastIxP1(i)= sortedData(tempIndex, 4);
            end 
            % Find the information for possition 2
            uniqueIDs= unique(sortedData(split:end,2));
            %initialize the structure containing the data to use in this analysis
            expData(fileIndex).idListP2= uniqueIDs';
            expData(fileIndex).tsListP2= zeros(1,length(uniqueIDs));
            expData(fileIndex).firstIxP2= zeros(1,length(uniqueIDs));
            expData(fileIndex).lastIxP2= zeros(1,length(uniqueIDs));
            for i= 1:length(uniqueIDs)
                % Find the TimeStamp and Raw data index for the first time the ID enters the volume and
                % extrapolate to the full sortedData set (instead of starting for the split position)
                tempIndex= find(sortedData(split:end,2)==uniqueIDs(i),1)+(split-1);
                expData(fileIndex).tsListP2(i)= sortedData(tempIndex, 3);
                expData(fileIndex).firstIxP2(i)= sortedData(tempIndex, 4);
                %Find the TimeStamp and Raw data index for the first time the ID enters the volume
                tempIndex= find(sortedData(:,2)==uniqueIDs(i),1, 'last');
                expData(fileIndex).lastIxP2(i)= sortedData(tempIndex, 4);
            end 
        end
    end
end
clear dataFromExcel dataSorted uniqueIDs fstIndex
% ==================================================
% ==================================================


% ====== Has any trajectory ID visited both cues? ======
% If any ID has visit both cues, keep only the cue visited as first choice
for expIndex=1:length(expData)
    disp(newline)
    disp(strcat('Experiment dated:', char(fileNameList(expIndex))));
    disp(strcat('   - # of Ids visiting P1: ', num2str(length(expData(expIndex).idListP1))));
    disp(strcat('   - # of Ids visiting P2: ', num2str(length(expData(expIndex).idListP2))));
    visitBothCues= ismember(expData(expIndex).idListP2,expData(expIndex).idListP1);
    % visitBothCues==0 ID not repeated and visitBothCues==1 ID repeated in both cues
    if any(visitBothCues)
        [repeats,value]= groupcounts(visitBothCues');    %how many 0 and 1 are repeated
        disp(strcat('   - # of Ids visiting both cues: ', num2str(repeats(2))));
        for i= find(visitBothCues ==1)
            %Check which of both cues was visited as first choice
            j= expData(expIndex).idListP1 == expData(expIndex).idListP2(i);
            if (expData(expIndex).tsListP1(j) -  expData(expIndex).tsListP2(i)) > 0
                %The visit in Pos1 happened after the visit of Pos2
                % Change the information for ID to 0 to remove later from matrix
                expData(expIndex).idListP1(j)= 0;
                expData(expIndex).tsListP1(j)= 0;
                expData(expIndex).firstIxP1(j)= 0;
                expData(expIndex).lastIxP1(j)= 0;
            else
                %The visit in Pos2 happened after the visit of Pos1             
                % Change the information for ID to 0 to remove later from matrix
                expData(expIndex).idListP2(i)= 0;
                expData(expIndex).tsListP2(i)= 0;
                expData(expIndex).firstIxP2(i)= 0;
                expData(expIndex).lastIxP2(i)= 0;
            end
        end
    end
    %Check how many value will be eleminated from each idList
    disp(strcat('   - # of Ids visiting P1 as second cue choice: ', num2str(numel(find(expData(expIndex).idListP1==0)))));
    disp(strcat('   - # of Ids visiting P2 as second cue choice: ', num2str(numel(find(expData(expIndex).idListP2==0)))));
    
    %Clean all values for the IDs set to 0
    expData(expIndex).idListP1(expData(expIndex).idListP1 == 0) =[];
    expData(expIndex).tsListP1(expData(expIndex).tsListP1 == 0) =[];
    expData(expIndex).firstIxP1(expData(expIndex).firstIxP1 == 0)= [];
    expData(expIndex).lastIxP1(expData(expIndex).lastIxP1 == 0)= [];
    expData(expIndex).idListP2(expData(expIndex).idListP2 == 0) =[];
    expData(expIndex).tsListP2(expData(expIndex).tsListP2 == 0) =[];
    expData(expIndex).firstIxP2(expData(expIndex).firstIxP2 == 0)= [];
    expData(expIndex).lastIxP2(expData(expIndex).lastIxP2 == 0)= [];
end
clear repeat values visitBothCues i j expIndex
% ==================================================
% ==================================================


% ========== Spatial representation of preference index prior vue visit ===============
% Look for the duration in time for each trajectory ID and keep all the
% trajecotories with tLimit sec or more before the trajecotry enters a volume
tLimit= 2; % num opf seconds before the trajectory reach the volume
mainIndex= 1;
%Initialize parameter for multidimensional array
xEdges= -lim_x:0.02:lim_x; %-0.76:0.02:0;
zEdges= 0:0.02:lim_z;
XZplane= NaN(length(xEdges)-1, length(zEdges)-1, 1);

for expIndex=1:length(expData)
    count= 0;
    for i= 1:length(expData(expIndex).idListP1)
        %Find the indexes for the choosen trajectory ID
        ix= find(dataset(expIndex).attr_id == expData(expIndex).idListP1(i));
        if (expData(expIndex).tsListP1(i) - dataset(expIndex).attr_time(ix(1))) >= tLimit
            %Find the first point for the trajectory detected 2 sec before the traj reach the volume
            trajInitialTime= expData(expIndex).tsListP1(i)-tLimit;
            trajInitialIndex= find(dataset(expIndex).attr_time(ix) >= trajInitialTime, 1);
            % crop the indexes from the trajectory to keep only part we are interested.
            indexesToUse= ix(trajInitialIndex):expData(expIndex).lastIxP1(i);
            
            % Find how many points from trajectory are in each of the sides of the Y axis
            % and generate the PI value to be added for each square in the XZ plane
            ctsP1= numel(find(dataset(expIndex).attr_y(indexesToUse) > 0));
            ctsP2= numel(find(dataset(expIndex).attr_y(indexesToUse) < 0));
            if baseColorIndexList(expIndex) == 1
                %Base cue was placed in the Pos-1
                tempPI= (ctsP2-ctsP1)/(ctsP1+ctsP2);
            else
                %Base cue was placed in the Pos-2
                tempPI= (ctsP1-ctsP2)/(ctsP1+ctsP2);
            end

            %Create the XZ plane as a square grid and find which squares
            %where visited by trajectory
            h=histcounts2(dataset(expIndex).attr_x(indexesToUse),dataset(expIndex).attr_z(indexesToUse),xEdges, zEdges);
            
            %Find in which bins were visited by the trajectory ID
            p= h > 0;
            p2= h== 0;
            %Store the PI value generated for this trajectory ID in the bins visited by it
            h(p)= tempPI;
            h(p2)=NaN;
            %Add the histcounts bins plane to the multidimensional array (3rd dimmension) as a new page
            XZplane(:,:,mainIndex)= h;
            mainIndex= mainIndex+1;
            count= count+1;
        end
    end
    %disp(strcat('total trajectories visitn Pos-1 as first choice longer that 2 sec', {' '}, num2str(count)));
    count= 0;
    for i= 1:length(expData(expIndex).idListP2)
        ix= find(dataset(expIndex).attr_id == expData(expIndex).idListP2(i));
        if (expData(expIndex).tsListP2(i) - dataset(expIndex).attr_time(ix(1))) >= tLimit
            %Find the first point for the trajectory detected 2 sec before the traj reach the volume
            trajInitialTime= expData(expIndex).tsListP2(i)-tLimit;
            trajInitialIndex= find(dataset(expIndex).attr_time(ix) >= trajInitialTime, 1);
            % extrapolate the index from the ix index List to the real position omn the RAW DATA
            indexesToUse= ix(trajInitialIndex):expData(expIndex).lastIxP2(i);

            % Find how many points from trajectory are in each of the sides of the Y axis
            % and generate the PI value to be added for each square in the XZ plane
            ctsP1= numel(find(dataset(expIndex).attr_y(indexesToUse) > 0));
            ctsP2= numel(find(dataset(expIndex).attr_y(indexesToUse) < 0));
            if baseColorIndexList(expIndex) == 1
                %Base cue was placed in the Pos-1
                tempPI= (ctsP2-ctsP1)/(ctsP1+ctsP2);
            else
                %Base cue was placed in the Pos-2
                tempPI= (ctsP1-ctsP2)/(ctsP1+ctsP2);
            end

            %Create the XZ plane as a square grid and find which squares where visited by trajectory
            h=histcounts2(dataset(expIndex).attr_x(indexesToUse),dataset(expIndex).attr_z(indexesToUse),xEdges, zEdges);
            
            %Find in which bins were visited by the trajectory ID
            p= h > 0;
            p2= h==0;
            %Store the PI value generated for this trajectory ID in the bins visited by it
            h(p)= tempPI;
            h(p2)=NaN;
            % Add the trajectory ID information to the multidimensional
            % array (3rd dimension is ID index)
            %Add the histcounts bins plane to the multidimensional array (3rd dimmension)           
            XZplane(:,:,mainIndex)= h;
            mainIndex= mainIndex + 1;
            count= count + 1;
        end
    end
    %disp(strcat(char(fileNameList(expIndex)),': Total trajectories visiting Pos-2 as first choice longer that 2 sec:', num2str(count)));  
end
clear expIndex tLimit tempPI h p count ctsP1 ctsP2 indexesToUse trajInitialtime trajInitialIndex ix i p1Counts

% Generate the mean PI value for each bin in the XZplane (use 3rd dimension)
meanXZplane= nanmean(XZplane,3);
% plot the mean PI values for eacjh bin in the XZ plane
figure();
minv = min(min(meanXZplane));
maxv = max(max(meanXZplane));
meanXZplane(isnan(meanXZplane)) = minv-((maxv-minv)/max(size(meanXZplane)));


% ddd=[0 0 0;jet(6)];
% colormap(ddd);

newmap = redblue;%jet(20);                    %starting map
ncol = size(newmap,1);           %how big is it?
zpos = 1;%floor(1/2 * ncol);    %2/3 of way through
newmap(zpos,:) = [0 0 0];        %set that position to white
colormap(newmap);                %activate it
%X=1:size(meanXZplane,1);
%Y=1:size(meanXZplane,2);
%X=-lim_x:lim_x;
%Y=1:size(meanXZplane,2);

%s= contourf(meanXZplane');

s=pcolor(xEdges(1:end-1),zEdges(1:end-1),meanXZplane');
%s.FaceColor='interp';
cb= colorbar;
caxis([-0.5 0.5]);
%set(cb, 'ylim', [-1 1])
xlabel('X Axis');
ylabel('Y Axis');
title('Spatial representation of preference index prior vue visit');
clear cb

% figure();
% pcolor(meanXZplane','ShowEmptyBins','on')
% colormap(hot)
% cb= colorbar;
% set(cb, 'ylim', [-1 1])
% xlabel('X Axis');
% ylabel('Y Axis');
% title('Spatial representation of preference index prior vue visit');
% clear cb
%==================================================
%==================================================
%   =======
% === END ===
%   =======







% ==================================================
% Generate PI values for each group of 60 seconds and study its variation
% between 1hr and 2h CO2
duration=60; %(1 hour)
p1BaseC= find(baseColorIndexList == 1);
p2BaseC= find(baseColorIndexList== 2);
% Group the data per base and tested color 
countsInBaseClr= [p1CO2(p1BaseC, 1:duration); p2CO2(p2BaseC, 1:duration)];
countsInTestClr= [p2CO2(p1BaseC, 1:duration); p1CO2(p2BaseC, 1:duration)];
countsInBaseClr_L= [p1CO2(p1BaseC, 1:duration*2); p2CO2(p2BaseC, 1:duration)];
countsInTestClr_L= [p2CO2(p1BaseC, 1:duration*2); p1CO2(p2BaseC, 1:duration)];
totalCounts= countsInBaseClr + countsInTestClr;

totalCounts_L= countsInBaseClr_L + countsInTestClr_L;

for i=1:duration*2
    if i <= duration
        %pi= (mean(countsInTestClr(:,i))- mean(countsInBaseClr(:,i)))/mean(totalCounts(:,i));
        %piList2(i)= pi;
        pi_1hr= (mean(countsInTestClr(2:end,i))- mean(countsInBaseClr(2:end,i)))/mean(totalCounts(2:end,i));
        piList2(i)= pi_1hr;
        
    end    
    pi= (countsInTestClr_L(1,i)- countsInBaseClr_L(1,i))/totalCounts_L(1,i);
    piList3(i)= pi;  
end 

% NaN values eliminated form dataset to calculate the mean of the PI value
tempPiCountsList= piList2;
tempPiCountsList(isnan(tempPiCountsList))=[];
disp(strcat('  * Mean PI for all timegrps 1Hr: ',num2str(mean(tempPiCountsList))));
tempPiTimeList= piList3;
tempPiTimeList(isnan(tempPiTimeList))=[];
disp(strcat('  * Mean PI for all timegrps 2Hr: ',num2str(mean(tempPiTimeList))));

% Empty values set to 0 for data visualization purposes
piList2(isempty(piList2))=0;
piList3(isempty(piList3))=0;
% Plot the 
figure()
subplot(2,1,1);
bar(piList2)
title(strcat('Preference index per time group (1 hr. CO2):',{' '}, baseColor, {' vs '},testedColorList(1)));
ylabel('Preference Index');
xlabel('Minutes');
subplot(2,1,2);
bar(piList3)
title(strcat('Preference index per time group (2 hr. CO2):',{' '}, baseColor, {' vs '},testedColorList(1)));
ylabel('Preference Index');
xlabel('Minutes');

% ==================================================
% ==================================================



%===================================================
% Estimate PI values per day for all activity during CO2 (using delta times)
p1BaseC= find(baseColorIndexList == 1);
p2BaseC= find(baseColorIndexList== 2);
% Group the data per base and tested color 
countsInBaseClr_L= [p1CO2(p1BaseC, 1:duration*2); p2CO2(p2BaseC, 1:duration*2)];
countsInTestClr_L= [p2CO2(p1BaseC, 1:duration*2); p1CO2(p2BaseC, 1:duration*2)];
timeInBaseClr_L= [t1CO2(p1BaseC, 1:duration*2); t2CO2(p2BaseC, 1:duration*2)];
timeInTestClr_L= [t2CO2(p1BaseC, 1:duration*2); t1CO2(p2BaseC, 1:duration*2)];
totalCounts_L= sum(countsInBaseClr_L + countsInTestClr_L, 2);
totalTime_L= sum(timeInBaseClr_L + timeInTestClr_L, 2);
kkCcB= sum(countsInBaseClr_L,2);
kkCcT= sum(countsInTestClr_L,2);
kkTcB= sum(timeInBaseClr_L,2);
kkTcT= sum(timeInTestClr_L,2);
for i=1:length(countsInBaseClr_L(:,1))  
    piC= (kkCcT(i) - kkCcB(i))/totalCounts_L(i);
    piT= (kkTcT(i) - kkTcB(i))/totalTime_L(i);
    piC_list(i)= piC;
    piT_list(i)= piT;
end
piC_list(isnan(piC_list))=[];
piT_list(isnan(piT_list))=[];

figure()
subplot(2,1,1)
bar(piC_list)
title(strcat('Preference index per day:',{' '}, baseColor, {' vs '},testedColorList(1)));
ylabel('Preference Index');
xlabel('Minutes');
subplot(2,1,2)
bar(piT_list)
title(strcat('Preference index per time group (2 hr. CO2):',{' '}, baseColor, {' vs '},testedColorList(1)));
ylabel('Preference Index');
xlabel('Minutes');

clear countsInBaseClr_L countsInTestClr_L totalCounts_L
clear timeInBaseClr_L timeInTestClr_L totaltime_L
clear piC piT piC_list piT_list kkCcT kkCcB kkTcT kkTcB
% ====================================================
% ====================================================




% ==================================================   
% PLOT SINGLE TRAJ OF THE INSECT THAT STOOD THE MOST IN A CUE
% You can load the information from a particular file and plot the
% trajectory with the largest time in a cue
% ==================================================
filesPath= strcat(outputPath, outputFolder,'analysisData\');
numGrps=120; %=120 =60 sec per group || =4 =1800 sec per grp
% Choose que file related to the dataset do you want to open
fileIndex= 3;
fileName= strcat(dataset(fileIndex).fileName(1:15),'_countsInsideCueVol_CO2.xlsx');

%Matrices with the different ts values [(t1-t0), ..., (tn- t(n-1))] 
tDiff1 = zeros(length(filesList),numGrps); 
tDiff2 = zeros(length(filesList),numGrps);

disp(strcat(' - Working with file: ', {' '}, fileName));
dataFromExcel = table2array(readtable(strcat(filesPath, fileName)));
initialTS= dataFromExcel(1,4);    
finalTS= dataFromExcel(1,5);

%sort matrix in fct of the cue-id-timestamp
sortedData= sortrows(dataFromExcel(:,1:3));
%find the first appearence of the position 2 
split= find(sortedData(:,1) ==2,1);


%counts the number of repetiions for each ID in each cue
%Cue in Pos 1
[IDsCtsP1,IDsGrpP1] = groupcounts(sortedData(1:(split-1),2));
%Cue in Pos 2
[IDsCtsP2,IDsGrpP2] = groupcounts(sortedData(split:end,2));
%Find the estimation of the total duration spent by all insects in each cue
timeInPos1= sum(IDsCtsP1)/fps
timeInPos2= sum(IDsCtsP2)/fps 
% preference index towards POS 1
prefIndexPos=(timeInPos1 - timeInPos2)/ (timeInPos1+timeInPos2)


%Find Trajectories IDs with biger trajectories (at least half the
%biggest trajectory)

% Find the longest trajectory
ix= find(IDsCtsP1 == max(IDsCtsP1));
idToLook= IDsGrpP1(ix)';
ix= find(IDsCtsP2 == max(IDsCtsP2));
idToLook= horzcat(idToLook, IDsGrpP2(ix)');

%Select wichi ID do you want to plot
indexesID= find(dataset(fileIndex).attr_id(:) == idToLook(1));
%load experiment cues positions
cuesSetup= dataset(fileIndex).expCues;
% parameters for size of the volume around the cue and wind tunnel dimensions
radius= 0.07;
h= 0.04;
lim_x= 0.9144;
subplot(2,1,1);
plt1=plot(dataset(fileIndex).attr_x(indexesID), dataset(fileIndex).attr_y(indexesID), 'b');
hold on
% add starting and ending points
plot(dataset(fileIndex).attr_x(indexesID(1)), dataset(fileIndex).attr_y(indexesID(1)),'b', 'Marker', '>');
plot(dataset(fileIndex).attr_x(indexesID(end)), dataset(fileIndex).attr_y(indexesID(end)), 'xb');
%build the volume
x= -lim_x  + cell2mat(cuesSetup(2,2));
y= cell2mat(cuesSetup(2,3));
x1= x - radius;
x2= x + radius;
y1= y - radius;
y2= y + radius;
xValues= [x1, x2, x2, x1, x1];
yValues= [y1, y1, y2, y2, y1];
plot(xValues,yValues, ':r');
x= -lim_x  + cell2mat(cuesSetup(3,2));
y= cell2mat(cuesSetup(3,3));
x1= x - radius;
x2= x + radius;
y1= y - radius;
y2= y + radius;
xValues= [x1, x2, x2, x1, x1];
yValues= [y1, y1, y2, y2, y1];
plot(xValues,yValues, ':k');
plt1= add_visual_cues_to_plot(plt1, cuesSetup(:,[1 2 3]));
hold off
xlim([-0.91 0.91]);
ylim([-0.30 0.30]);
ylabel(' Y ');
xlabel(' X '); 
title(strcat('CO2 Trajectory: ',{' '}, num2str(idToLook(1)), {' '}, ' -Exp:', {' '}, dataset(fileIndex).fileName(1:8), '-', dataset(fileIndex).fileName(10:15)));   
subplot(2,1,2);
plt2=plot(dataset(fileIndex).attr_x(indexesID), dataset(fileIndex).attr_z(indexesID), 'b');
hold on
% add starting and ending points
plot(dataset(fileIndex).attr_x(indexesID(1)), dataset(fileIndex).attr_z(indexesID(1)),'b', 'Marker', '>');
plot(dataset(fileIndex).attr_x(indexesID(end)), dataset(fileIndex).attr_z(indexesID(end)), 'xb');
%build the volume
x= -lim_x  + cell2mat(cuesSetup(3,2));
z= 0;
x1= x - radius;
x2= x + radius;
z1= z ;
z2= z + h;
xValues= [x1, x2, x2, x1, x1];
zValues= [z1, z1, z2, z2, z1];
plot(xValues,zValues, ':k');
plt2= add_visual_cues_to_plot(plt2, cuesSetup(:,[1 2 4]));
hold off
xlim([-0.91 0.91]);
ylim([0.00 0.6]);    
ylabel(' Z ');
xlabel(' X ');



% ==================================================   
% Compare counts 1 hours CO2 vs 2 hrs CO2
% ==================================================
duration= 60;
x_L= 1:duration*2;
totalExp= length(filesNameCO2);
% Find in which position the base and test color wehre placed
p1BaseC= find(baseColorIndexList == 1);
p2BaseC= find(baseColorIndexList== 2);
%Generate the cummulative counts for the full 2 hours experiment
sumCountsInBaseClrCO2_L= cumsum([p1CO2(p1BaseC, 1:duration*2); p2CO2(p2BaseC, 1:duration*2)], 2);
sumCountsInTestClrCO2_L= cumsum([p2CO2(p1BaseC, 1:duration*2); p1CO2(p2BaseC, 1:duration*2)], 2);
totalCountsCO2_L= sumCountsInBaseClrCO2_L(:,end) +sumCountsInTestClrCO2_L(:,end);
%Do normalize and generate mean and stdev
tempNorm= bsxfun(@rdivide,(sumCountsInBaseClrCO2_L*100),totalCountsCO2_L);
tempNorm(isnan(tempNorm))=[]; 
meanCtsCO2cB_L= mean(tempNorm);
errCtsCO2cB_L= std(tempNorm)/sqrt(totalExp);
tempNorm= bsxfun(@rdivide,(sumCountsInTestClrCO2_L*100),totalCountsCO2_L);
tempNorm(isnan(tempNorm))=[]; 
meanCtsCO2cT_L= mean(tempNorm);
errCtsCO2cT_L= std(tempNorm)/sqrt(totalExp);

figure()
lg= [{'Base color'}, {'Test color'}];
%Data from COUNTS in CO2 for 1 hour
pp1=subplot(2,1,1);
% time near the cues with the Base color as cue
shadedErrorBar(x, meanCtsCO2cB', errCtsCO2cB','lineprops','-g')
pp1.YLim= [0 100];
hold on;
% time near the cues with the Test color as cue
shadedErrorBar(x, meanCtsCO2cT', errCtsCO2cT','lineprops','-b')
hold off;
xlabel('Minute #');
ylabel(' % time per position ');
title('Counts near White cue vs Black cue (1 hr. CO2)');
legend(lg, 'Location','eastoutside');  
%Data from COUNTS in CO2 during 2 hours
pp1=subplot(2,1,2);
% time near the cues with the Base color as cue
shadedErrorBar(x_L, meanCtsCO2cB_L', errCtsCO2cB_L','lineprops','-g')
pp1.YLim= [0 100];
hold on;
% time near the cues with the Test color as cue
shadedErrorBar(x_L, meanCtsCO2cT_L', errCtsCO2cT_L','lineprops','-b')
%Add as red points the max value after 1 hour
plot([60, 60], [0, 100], ':r');
hold off;
xlabel('Minute #');
ylabel(' % time per position ');
title('Counts near White cue vs Black cue (2 hr. CO2)');
legend(lg, 'Location','eastoutside');  
% ==================================================
% ==================================================




% 
% % ==================================================
% % Generate PI values for each group of 60 seconds and study its variation
% % between 1hr and 2h CO2
% duration=60; %(1 hour)
% p1BaseC= find(baseColorIndexList == 1);
% p2BaseC= find(baseColorIndexList== 2);
% % Group the data per base and tested color 
% countsInBaseClr= [p1CO2(p1BaseC, 1:duration); p2CO2(p2BaseC, 1:duration)];
% countsInTestClr= [p2CO2(p1BaseC, 1:duration); p1CO2(p2BaseC, 1:duration)];
% totalCounts= countsInBaseClr + countsInTestClr;
% 
% %piPerTimeGrp_list=zeros(length(filesList), duration);
% tempPI= zeros(1, duration);
% 
% for i=1: length(filesList)
%     for k=1:duration
%         %Generate the PI for the given ID
%         tempPI(k)= (countsInTestClr(i, k) - countsInBaseClr(i, k)) / (totalCounts(i, k));
%     end
%     tempPI(isnan(tempPI))=[];
%     countsInTimeGrp_list(i).piList= tempPI;
%     countsInTimeGrp_list(i).meanPI= mean(tempPI);
%     piPerTimeGrp_list(i,:)= tempPI;
%     
% end
% 
% %SCATTER PLOT
% figure()
% for k=1:length(filesList)  
%     subplot(2,length(filesList),k)
%     scatter(ones(1, size(countsInTimeGrp_list(k).piList,2)),countsInTimeGrp_list(k).piList, 'jitter', 'on')
%     hold on
%     plot(median(countsInTimeGrp_list(k).piList), 'ro', 'MarkerSize',10,'MarkerEdgeColor','r', 'MarkerFaceColor',[0.9,0.5,0.5]);
%     y= [countsInTimeGrp_list(k).meanPI, countsInTimeGrp_list(k).meanPI];
%     plot([0.7, 1.3], y, '--k', 'MarkerSize',15,'MarkerEdgeColor','k');
%     hold off
%     title('PI for counts in each cue per tGrp (60sec)');
%     ylabel('Preference Index'); 
%     xlim([0.5, 1.5]);
%     xlabel({strcat('# of tGrp with PI value= ',num2str(length(countsInTimeGrp_list(k).piList))); strcat('total Counts= ',num2str(sum(totalCounts(k,:))))});
%     subplot(2,length(filesList),k+length(filesList))
%     histogram(countsInTimeGrp_list(k).piList, [-1:0.1:1]);
%     ylabel(' Repeats for value');
%     xlabel('Preference Index')
%     title(filesName(k))
% end
% 
% %Bar plot showing the preference index per time group of 60 sec and the
% %mean value per time group of 60 sec
% figure()
% for i=1:length(filesName)
%     subplot(3,2,i)
%     %bar(countsInTimeGrp_list(i).piList)
%     bar(piPerTimeGrp_list(i,:))
%     hold on
%     %plot(mean(piPerTimeGrp_list), 'ro-', 'MarkerSize',5,'MarkerEdgeColor','r', 'MarkerFaceColor',[0.9,0.5,0.5])
%     hold off
%     ylabel('Preference Index');
%     xlabel('Minute #')
%     lg= [{'PI in  given time grp'}, {strcat('mean PI per time grp (',num2str(length(filesName)),' exp)')}];
%     legend(lg  ,'location', 'eastoutside');
%     title(filesName(i))
% end
% subplot(3,2,6)
% bar(mean(piPerTimeGrp_list))
% hold on
% plot(mean(piPerTimeGrp_list), 'ro-', 'MarkerSize',5,'MarkerEdgeColor','r', 'MarkerFaceColor',[0.9,0.5,0.5])
% hold off
% ylabel('Preference Index');
% xlabel('Minute #')
% title('mean for all experiments')
%    
% 
% % Bar plot to show the total counts used in each time group of 60 sec
% % average counts per time group of 60 sec during the 5 experiment
% figure()
% maxCts= max(max(totalCounts(:,:)));
% %lg= {'Total counts in time grp';
% for i=1:length(filesName)
%     subplot(3,2,i)
%     %bar(countsInTimeGrp_list(i).piList)
%     bar(totalCounts(i,:))
%     hold on
%     plot(mean(totalCounts), 'ro-', 'MarkerSize',5,'MarkerEdgeColor','r', 'MarkerFaceColor',[0.9,0.5,0.5])
%     hold off
%     ylabel('# of counts near any of the cues');
%     ylim([0, maxCts]);
%     xlabel('Minute #')
%     lg= [{'Total counts in time grp'}, {strcat('mean value per time grp (',num2str(length(filesName)),' exp)')}];
%     legend(lg  ,'location', 'eastoutside');
%     title(filesName(i))
% end
% clear maxCts
% ==================================================
% ==================================================